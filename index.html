<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Productos Tolerados - Descartes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <style>
        :root {
            --primary-color: #28a745;
            --danger-color: #dc3545;
            --border-color: #ced4da;
            --text-color: #495057;
            --bg-color: #e9ecef;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        h1 {
            font-size: 22px;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-color);
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: #007bff;
            outline: none;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .input-group.error .error-message {
            display: block;
        }

        .input-group.error input,
        .input-group.error select,
        .input-group.error textarea {
            border-color: var(--danger-color);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .button-group button[type="submit"] {
            background-color: var(--primary-color);
            color: #fff;
        }

        .button-group button[type="button"] {
            background-color: var(--danger-color);
            color: #fff;
        }

        .button-group button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading .spinner {
            display: inline-block;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Control de Productos Tolerados - Descartes</h1>
        <form id="productoForm" novalidate>
            <div class="input-group">
                <label for="numero">Nº</label>
                <input type="text" id="numero" name="numero" readonly>
            </div>

            <div class="input-group">
                <label for="fecha">Fecha</label>
                <input type="date" id="fecha" name="fecha" required>
                <div class="error-message">La fecha es requerida</div>
            </div>

            <div class="input-group">
                <label for="turno">Turno</label>
                <select id="turno" name="turno" required>
                    <option value="">Seleccione un turno</option>
                    <option value="DIA">DIA</option>
                    <option value="NOCHE">NOCHE</option>
                </select>
                <div class="error-message">Debe seleccionar un turno</div>
            </div>

            <div class="input-group">
                <label for="codigoProducto">Código de Producto</label>
                <input type="text" id="codigoProducto" name="codigoProducto" required>
                <div class="error-message">El código de producto es requerido</div>
            </div>

            <div class="input-group">
                <label for="numeroOrden">Nº Orden</label>
                <input type="text" id="numeroOrden" name="numeroOrden" required>
                <div class="error-message">El número de orden es requerido</div>
            </div>

            <div class="input-group">
                <label for="tolerado">Tolerado (Tarjeta Rosada)</label>
                <input type="number" id="tolerado" name="tolerado" required min="0">
                <div class="error-message">Ingrese un valor válido</div>
            </div>

            <div class="input-group">
                <label for="descarteTotal">Descarte Total (Tarjeta Celeste)</label>
                <input type="number" id="descarteTotal" name="descarteTotal" required min="0">
                <div class="error-message">Ingrese un valor válido</div>
            </div>

            <div class="input-group">
                <label for="observacion">Observación</label>
                <textarea id="observacion" name="observacion" rows="3"></textarea>
            </div>

            <div class="input-group">
                <label for="vipCalidad">VIP Calidad</label>
                <input type="text" id="vipCalidad" name="vipCalidad">
            </div>

            <div class="button-group">
                <button type="submit" id="submitButton">
                    <span class="spinner"></span>
                    <span class="button-text">Guardar</span>
                </button>
                <button type="button" onclick="limpiarFormulario()">Limpiar</button>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.js"></script>
    <script>
        // Configuración
        const CONFIG = {
            scriptURL: 'https://script.google.com/macros/s/AKfycbx6rX0mRwgav45TdgEpyNZMlx1pN6dn9cGZEQOcZU6VHPsBkArRhRmRvT1I5uPerXeJQw/exec',
            autoIncrementPrefix: 'DESC-',
            currentNumber: 1
        };

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            setInitialDate();
            updateNumeroField();
            initializeFormValidation();
        });

        // Establecer la fecha actual por defecto
        function setInitialDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = today;
        }

        // Actualizar el campo número
        function updateNumeroField() {
            const numeroField = document.getElementById('numero');
            numeroField.value = `${CONFIG.autoIncrementPrefix}${String(CONFIG.currentNumber).padStart(4, '0')}`;
        }

        // Inicializar validación del formulario
        function initializeFormValidation() {
            const form = document.getElementById('productoForm');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (validateForm()) {
                    await enviarDatos();
                }
            });

            form.querySelectorAll('input, select, textarea').forEach(element => {
                element.addEventListener('input', () => {
                    validateField(element);
                });
            });
        }

        // Validar formulario completo
        function validateForm() {
            let isValid = true;
            const form = document.getElementById('productoForm');
            
            form.querySelectorAll('[required]').forEach(element => {
                if (!validateField(element)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // Validar campo individual
        function validateField(element) {
            const inputGroup = element.closest('.input-group');
            let isValid = true;

            if (element.hasAttribute('required') && !element.value.trim()) {
                inputGroup.classList.add('error');
                isValid = false;
            } else if (element.type === 'number' && (element.value < 0 || element.value === '')) {
                inputGroup.classList.add('error');
                isValid = false;
            } else {
                inputGroup.classList.remove('error');
            }

            return isValid;
        }

        // Enviar datos al backend
        async function enviarDatos() {
    const submitButton = document.getElementById('submitButton');
    const buttonText = submitButton.querySelector('.button-text');
    
    try {
        // Deshabilitar botón y mostrar loading
        submitButton.disabled = true;
        submitButton.classList.add('loading');
        buttonText.textContent = 'Guardando...';

        const formData = getFormData();
        
        console.log('Enviando datos:', formData); // Para debugging

        const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            mode: 'no-cors', // Importante para CORS
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        console.log('Respuesta recibida'); // Para debugging
        
        showNotification('¡Datos enviados correctamente!', 'success');
        CONFIG.currentNumber++;
        updateNumeroField();
        limpiarFormulario();

    } catch (error) {
        console.error('Error al enviar datos:', error);
        showNotification('Error al enviar los datos. Por favor, intente nuevamente.', 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.classList.remove('loading');
        buttonText.textContent = 'Guardar';
    }
}

        // Obtener datos del formulario
        function getFormData() {
            return {
                numero: document.getElementById('numero').value,
                fecha: document.getElementById('fecha').value,
                turno: document.getElementById('turno').value,
                codigoProducto: document.getElementById('codigoProducto').value,
                numeroOrden: document.getElementById('numeroOrden').value,
                tolerado: document.getElementById('tolerado').value,
                descarteTotal: document.getElementById('descarteTotal').value,
                observacion: document.getElementById('observacion').value,
                vipCalidad: document.getElementById('vipCalidad').value
            };
        }

        // Mostrar notificación
        function showNotification(message, type) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: type === 'success' ? "#28a745" : "#dc3545",
                stopOnFocus: true
            }).showToast();
        }

        // Limpiar formulario
        function limpiarFormulario() {
            const form = document.getElementById('productoForm');
            form.reset();
            setInitialDate();
            
            form.querySelectorAll('.input-group').forEach(group => {
                group.classList.remove('error');
            });
        }
    </script>
</body>
</html>
